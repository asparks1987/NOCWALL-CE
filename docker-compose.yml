services:
  uisp-noc:
    image: predheadtx/uisp-noc:beta
    container_name: uisp-noc
    environment:
      UISP_URL: ${UISP_URL:-https://example.unmsapp.com}
      UISP_TOKEN: ${UISP_TOKEN:-changeme}
      GOTIFY_DEFAULTUSER_NAME: ${GOTIFY_DEFAULTUSER_NAME:-admin}
      GOTIFY_DEFAULTUSER_PASS: ${GOTIFY_DEFAULTUSER_PASS:-changeme}
      SHOW_TLS_UI: ${SHOW_TLS_UI:-false}
    volumes:
      - noc_cache:/var/www/html/cache
    restart: unless-stopped

  api:
    image: predheadtx/uisp-api:beta
    container_name: uisp-api
    environment:
      API_ADDR: :8080
      API_BASE_URL: ${API_BASE_URL:-http://api:8080}
      UISP_BASE_URL: ${UISP_BASE_URL:-http://uisp-noc}
      APP_ENV: ${APP_ENV:-dev}
      API_TOKEN: ${API_TOKEN:-}
      DATA_FILE: /data/store.json
    ports:
      - "8080:8080"
    volumes:
      - api_data:/data
    restart: unless-stopped

  caddy:
    image: caddy:2
    container_name: uisp-caddy
    depends_on:
      - uisp-noc
      - api
    environment:
      NOC_DOMAIN: ${NOC_DOMAIN:-noc.example.com}
      ACME_EMAIL: ${ACME_EMAIL:-admin@example.com}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - caddy_data:/data
      - caddy_config:/config
    configs:
      - source: caddyfile
        target: /etc/caddy/Caddyfile
    restart: unless-stopped

volumes:
  noc_cache:
  api_data:
  caddy_data:
  caddy_config:

configs:
  caddyfile:
    content: |
      {
          email {env.ACME_EMAIL}
          admin 0.0.0.0:2019
      }

      :80 {
          @api path /api/* /mobile/config /devices /incidents /push/register /health /agents /agents/register /telemetry/ingest /events/ingest
          reverse_proxy @api api:8080
          reverse_proxy uisp-noc:80
      }
